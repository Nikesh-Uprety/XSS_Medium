name: SecFinOps Auto-Fix Validator

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize]

permissions:
  contents: write
  pull-requests: write
  security-events: write

jobs:
  detect-autofix-pr:
    runs-on: ubuntu-latest
    outputs:
      is_autofix: ${{ steps.check.outputs.is_autofix }}
    steps:
      - name: Check if SecFinOps AutoFix PR
        id: check
        run: |
          if [[ "${{ github.head_ref }}" == autofix/* ]]; then
            echo "is_autofix=true" >> $GITHUB_OUTPUT
          else
            echo "is_autofix=false" >> $GITHUB_OUTPUT
          fi

  validate-fix:
    needs: detect-autofix-pr
    if: needs.detect-autofix-pr.outputs.is_autofix == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Install dependencies
        run: npm ci

      # -------------------------------
      # Install Semgrep properly
      # -------------------------------
      - name: Install Semgrep
        run: |
          python3 -m pip install --upgrade pip
          pip install semgrep

      # -------------------------------
      # Run Semgrep and fail only on XSS
      # -------------------------------
      - name: Security scan (XSS validation)
        run: |
          echo "Running Semgrep scan..."
          semgrep --config=auto --json > semgrep-results.json

          python3 <<EOF
          import json, sys

          try:
              with open("semgrep-results.json") as f:
                  results = json.load(f)
          except Exception as e:
              print(f"Failed to parse Semgrep results: {e}")
              sys.exit(1)

          xss_findings = [
              r for r in results.get("results", [])
              if "xss" in r.get("check_id", "").lower()
          ]

          if xss_findings:
              print(f"XSS vulnerabilities still found: {len(xss_findings)}")
              sys.exit(1)

          print("No XSS findings. Fix validated.")
          EOF

      # -------------------------------
      # Run tests only if they exist
      # -------------------------------
      - name: Run unit tests (if present)
        run: |
          if node -e "const p=require('./package.json'); process.exit(p.scripts && p.scripts.test ? 0 : 1)" 2>/dev/null
          then
            echo "Test script found. Running tests..."
            npm test -- --passWithNoTests
          else
            echo "No test script found. Skipping tests."
          fi

      # -------------------------------
      # Post validation result
      # -------------------------------
      - name: Post validation result comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}';
            const message = status === 'success'
              ? '**SecFinOps AutoFix Validated** ✅\n\nSecurity scan passed. No XSS findings detected. Auto-merging.'
              : '**SecFinOps AutoFix Validation Failed** ❌\n\nSecurity issues still detected or tests failed. Manual review required.';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });

      # -------------------------------
      # Auto-merge if everything passed
      # -------------------------------
      - name: Auto-merge PR
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              merge_method: 'squash',
              commit_title: `fix: SecFinOps AutoFix - ${context.payload.pull_request.title}`,
              commit_message: 'Automatically validated and merged by SecFinOps AutoFix pipeline'
            });

            console.log("PR auto-merged successfully.");
